<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººé‹å‹•è¨“ç·´æ•¸æ“šå„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --bg: #f1f5f9; --text: #1e293b; --card-bg: #ffffff;
            --header-dark: #1e293b;
            --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 15px; background: linear-gradient(135deg, var(--header-dark), #334155); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .header h1 { margin: 0; font-size: 20px; letter-spacing: 1px; }
        .loading-text { margin-top: 8px; font-size: 13px; color: #cbd5e1; }

        /* [çµ±ä¸€] æ¨™é¡Œæ¨£å¼ (å·¦å´è‰²æ¢) */
        .chart-header { border-left: 4px solid var(--primary); padding-left: 10px; }
        .nutri-header { border-left: 4px solid var(--warning); padding-left: 10px; }
        
        /* å¡ç‰‡å…±ç”¨ */
        .info-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .base-info { font-size: 11px; color: #64748b; font-weight: normal; }

        /* é£²é£ŸæŒ‡å¼•æŒ‰éˆ• */
        .nutri-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .n-btn { padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; cursor: pointer; text-align: center; transition: all 0.2s; }
        .n-btn h3 { margin: 0 0 4px; font-size: 14px; }
        .n-btn p { margin: 0; font-size: 10px; color: #64748b; }
        .n-btn.active { border-color: transparent; color: white; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .n-btn.active p { color: rgba(255,255,255,0.8); }
        .btn-high { border-bottom: 3px solid var(--danger); } .btn-high.active { background: var(--danger); }
        .btn-mid { border-bottom: 3px solid var(--warning); } .btn-mid.active { background: var(--warning); }
        .btn-low { border-bottom: 3px solid var(--success); } .btn-low.active { background: var(--success); }

        .nutri-result { background: #f0f9ff; padding: 15px; border-radius: 8px; display: none; animation: fadeIn 0.3s; }
        .nutri-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; border-bottom: 1px solid #e0f2fe; padding-bottom: 10px; }
        .n-metric label { font-size: 11px; color: #64748b; display: block; }
        .n-metric span { font-size: 18px; font-weight: bold; color: #0c4a6e; }
        .n-advice-box { background: #fff; padding: 10px; border-radius: 6px; font-size: 13px; color: #475569; line-height: 1.5; border-left: 3px solid #3b82f6; margin-top: 10px; }
        .n-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 5px; font-weight: bold; }

        /* [æ–°å¢] è›‹ç™½è³ªåƒè€ƒè¡¨ */
        .protein-ref {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            font-size: 11px; color: #475569; background: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px;
        }
        .pro-item { display: flex; align-items: center; gap: 4px; }

        /* åˆ†æç‹€æ…‹ */
        .analysis-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; color: white; font-weight: bold; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; background-color: white; border-radius: 50%; display: inline-block; }
        .analysis-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .metric-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; position: relative; }
        .metric-label { font-size: 11px; color: #64748b; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .info-icon { width: 16px; height: 16px; background: #3b82f6; color: white; border-radius: 50%; font-size: 11px; line-height: 16px; cursor: pointer; display: inline-block; font-weight: bold; }
        .metric-value { font-size: 16px; font-weight: bold; color: #334155; }
        .metric-unit { font-size: 10px; color: #94a3b8; }
        .advice-box { background: #f0f9ff; padding: 15px; border-radius: 8px; font-size: 14px; color: #0c4a6e; line-height: 1.5; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-title { font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .modal-content { font-size: 14px; color: #475569; line-height: 1.6; text-align: left; }
        .modal-btn { display: block; width: 100%; padding: 12px; margin-top: 20px; background: var(--primary); color: white; text-align: center; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        .chart-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 380px; display: flex; flex-direction: column; }
        .chart-container { flex: 1; width: 100%; min-height: 0; }
        h2 { font-size: 15px; margin: 0 0 10px; padding-left: 10px; color: var(--text); display: flex; align-items: center; justify-content: space-between; }
        select { font-size: 12px; padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        .legend-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #64748b; margin-bottom: 5px; background: #f8fafc; padding: 6px 8px; border-radius: 4px; flex-wrap: wrap; gap: 5px; }
        .legend-group { display: flex; gap: 8px; align-items: center; }
        .legend-item { display: flex; align-items: center; white-space: nowrap; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 3px; display: inline-block; }
        .dot-green { background: #dcfce7; border: 1px solid #10b981; }
        .dot-yellow { background: #fef9c3; border: 1px solid #f59e0b; }
        .dot-red { background: #fee2e2; border: 1px solid #ef4444; }
        .icon-bar { width: 10px; height: 8px; background: #1e293b; border-radius: 2px; margin-right: 3px; display: inline-block; }
        .icon-line-acwr { width: 10px; height: 2px; background: #f59e0b; margin-right: 3px; display: inline-block; position: relative; top: -1px; }
        .icon-line-acwr::after { content: ''; position: absolute; width: 4px; height: 4px; background: #fff; border: 1px solid #f59e0b; border-radius: 50%; top: -2px; left: 3px; }
        .icon-line-perf { width: 10px; height: 2px; background: #8b5cf6; margin-right: 3px; display: inline-block; position: relative; top: -1px; } 
        .icon-line-hrv { width: 10px; height: 2px; border-bottom: 2px dashed #ec4899; margin-right: 3px; display: inline-block; position: relative; top: -2px; } 
        
        .chart-helper-text { font-size: 11px; color: #64748b; margin-bottom: 5px; background: #f8fafc; padding: 5px; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 8px; }
        .legend-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 2px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>é‹å‹•è¨“ç·´æ•¸æ“šå„€è¡¨æ¿</h1>
        <div id="loadingStatus" class="loading-text">æ­£åœ¨é€£ç·š Google Sheets...</div>
    </div>

    <!-- é£²é£ŸæŒ‡å¼• (åç¨±ç¸®çŸ­ç‚º4å­—) -->
    <div class="info-card nutrition-section">
        <div class="section-title nutri-header">
            é£²é£ŸæŒ‡å¼•
            <span class="base-info" id="userBaseInfo">è®€å–ä¸­...</span>
        </div>
        <div class="nutri-btns">
            <div class="n-btn btn-high" onclick="updateNutrition('high', this)">
                <h3>ğŸ”¥ æˆ°é¬¥æ¨¡å¼</h3>
                <p>æ ¼é¬¥ / å°ç·´</p>
            </div>
            <div class="n-btn btn-mid" onclick="updateNutrition('mid', this)">
                <h3>ğŸ‹ï¸ ç¶­æŒæ¨¡å¼</h3>
                <p>å¥èº« / æŠ€è¡“</p>
            </div>
            <div class="n-btn btn-low" onclick="updateNutrition('low', this)">
                <h3>ğŸƒ ç‡ƒè„‚æ¨¡å¼</h3>
                <p>Zone 2 / ä¼‘æ¯</p>
            </div>
        </div>
        <div id="nutriResult" class="nutri-result">
            <div class="nutri-grid">
                <div class="n-metric">
                    <label>ä»Šæ—¥ç†±é‡ç›®æ¨™</label>
                    <span id="targetCal">--</span> kcal
                </div>
                <div class="n-metric">
                    <label>è›‹ç™½è³ªä½æ¶ˆ</label>
                    <div><span id="targetProtein">--</span> g</div>
                </div>
            </div>
            
            <!-- [æ–°å¢] å¯¦ç”¨çš„è›‹ç™½è³ªæ›ç®—è¡¨ -->
            <div class="protein-ref">
                <div class="pro-item">ğŸ¥© è±¬/é›è‚‰ (1æŒ) â‰ˆ 22g</div>
                <div class="pro-item">ğŸ¥› è±†æ¼¿ (1ç›’) â‰ˆ 14g</div>
                <div class="pro-item">ğŸ¥š èŒ¶è‘‰è›‹ (1é¡†) â‰ˆ 7g</div>
                <div class="pro-item">ğŸ’ª ä¹³æ¸… (1åŒ™) â‰ˆ 25g</div>
            </div>

            <div class="n-advice-box" id="targetAdvice">--</div>
        </div>
    </div>

    <!-- æœ¬é€±æˆ°æƒ…åˆ†æå¡ -->
    <div id="analysisCard" class="info-card" style="display:none;">
        <div class="section-title chart-header">
            <span id="analysisDate">æœ¬é€±ç‹€æ³åˆ†æ</span>
            <div id="analysisBadge" class="analysis-status">è¨ˆç®—ä¸­</div>
        </div>
        <div class="analysis-grid">
            <div class="metric-box">
                <div class="metric-label" onclick="showInfo('load')">æœ¬é€±è² è· <span class="info-icon">?</span></div>
                <div class="metric-value" id="valLoad">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label" onclick="showInfo('acwr')">ACWR é¢¨éšª <span class="info-icon">?</span></div>
                <div class="metric-value" id="valAcwr">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label" onclick="showInfo('hrv')">HRV ç‹€æ…‹ <span class="info-icon">?</span></div>
                <div class="metric-value" id="valHrv">--</div>
                <div class="metric-unit">é€±å¹³å‡</div>
            </div>
            <div class="metric-box">
                <div class="metric-label" onclick="showInfo('tsb')">é æ¸¬è¡¨ç¾ <span class="info-icon">?</span></div>
                <div class="metric-value" id="valTsb">--</div>
            </div>
        </div>
        <div class="advice-box" id="valAdvice">æ­£åœ¨åˆ†ææ•¸æ“š...</div>
    </div>

    <!-- è³‡è¨Šå½ˆçª— -->
    <div id="infoModal" class="modal-overlay" onclick="closeInfo(event)">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title">æ¨™é¡Œ</div>
            <div id="modalContent" class="modal-content">å…§å®¹</div>
            <button class="modal-btn" onclick="document.getElementById('infoModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div class="grid">
        <div class="chart-card">
            <!-- [ä¿®æ­£] åŠ ä¸Š chart-header æ¨£å¼ -->
            <h2 class="chart-header">è¨“ç·´è² è·</h2>
            <div class="legend-row">
                <div class="legend-group">
                    <div class="legend-item"><span class="dot dot-green"></span>æœ€ä½³</div>
                    <div class="legend-item"><span class="dot dot-yellow"></span>è­¦æˆ’</div>
                    <div class="legend-item"><span class="dot dot-red"></span>å±éšª</div>
                </div>
                <div class="legend-group">
                    <div class="legend-item"><span class="icon-bar"></span>ç¸½è² è·</div>
                    <div class="legend-item"><span class="icon-line-acwr"></span>ACWR</div>
                    <div class="legend-item"><span class="icon-line-perf"></span>é æ¸¬è¡¨ç¾</div>
                    <div class="legend-item"><span class="icon-line-hrv"></span>HRV</div>
                </div>
            </div>
            <div id="chartLoad" class="chart-container"></div>
        </div>
        <div class="chart-card"><h2 class="chart-header">è¨“ç·´çµæ§‹</h2><div id="chartStack" class="chart-container"></div></div>
        <div class="chart-card"><h2 class="chart-header">è¨“ç·´è¶¨å‹¢</h2><div id="chartTrend" class="chart-container"></div></div>
        
        <div class="chart-card" style="margin-bottom: 20px;">
            <h2 class="chart-header">é«”æ…‹è¶¨å‹¢</h2>
            <div class="chart-helper-text">
                <span><span class="legend-dot" style="background:#3b82f6"></span>è‚Œè‚‰é‡ (kg)</span>
                <span><span class="legend-dot" style="background:#ef4444"></span>é«”è„‚ç‡ (%)</span>
                <span><span class="legend-dot" style="background:#333"></span>é«”é‡ (kg)</span>
            </div>
            <div id="chartBody" class="chart-container"></div>
        </div>

        <div class="chart-card">
            <h2 class="chart-header">è¨“ç·´åˆ†æ <select id="pieMonthSelect"></select></h2>
            <div id="chartPie" class="chart-container"></div>
        </div>
    </div>
</div>

<script>
    const YOUR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfKipyUTKtVPZ4HUcse4iJZjkD5fw_3HzmMgkCfi6UDphbjOZidlqMXFuGOhu0FiJCLzJcKtgt2Dqy/pub?gid=1055429386&single=true&output=csv';

    let rawData = [];
    let weeklyData = [];
    let bodyData = [];
    let latestBodyStats = { bmr: 1800, weight: 80, date: '--' };

    const categories = ['æ­¦è¡“', 'æ ¼é¬¥', 'å°ç·´', 'å¥èº«', 'HIIT', 'Zone 2'];
    const colors = ['#F43F5E', '#2563EB', '#8B5CF6', '#F59E0B', '#0EA5E9', '#10B981'];
    // å‚™ç”¨æ¬Šé‡
    const intensityWeights = { 'æ­¦è¡“': 1.0, 'æ ¼é¬¥': 1.5, 'å¥èº«': 1.2, 'å°ç·´': 1.8, 'HIIT': 2.0, 'Zone 2': 0.8 };
    
    const infoData = {
        'load': { title: 'æœ¬é€±è² è· (sRPE)', content: `<p>æ•¸å€¼ä¾†æºï¼šsRPE (æ™‚é–“Ã—å¼·åº¦)ã€‚</p><ul><li>é€™æ˜¯æœ¬é€±ç´¯ç©çš„ç¸½å£“åŠ›ã€‚</li><li>é¿å…å–®é€±æš´è¡ (>20%)ã€‚</li></ul>` },
        'acwr': { title: 'ACWR é¢¨éšªä¿‚æ•¸', content: `<ul><li><span style="color:#10b981">â—</span> <strong>0.8 - 1.3</strong>ï¼šå®‰å…¨å€ã€‚</li><li><span style="color:#f59e0b">â—</span> <strong>1.3 - 1.5</strong>ï¼šè­¦æˆ’å€ã€‚</li><li><span style="color:#ef4444">â—</span> <strong>> 1.5</strong>ï¼šå±éšªå€ã€‚</li></ul>` },
        'hrv': { title: 'HRV ç‹€æ…‹ (Readiness)', content: `<ul><li><span style="color:#10b981">â—</span> <strong>> 75%</strong>ï¼šç‹€æ…‹ä½³ã€‚</li><li><span style="color:#f59e0b">â—</span> <strong>60% - 75%</strong>ï¼šå¾®ç–²å‹ã€‚</li><li><span style="color:#ef4444">â—</span> <strong>< 60%</strong>ï¼šéœ€ä¼‘æ¯ã€‚</li></ul>` },
        'tsb': { title: 'é æ¸¬è¡¨ç¾ (TSB)', content: `<p>å…¬å¼ï¼šé«”èƒ½ - ç–²å‹ã€‚</p><ul><li><strong>è² å€¼</strong>ï¼šç´¯ç©ç–²å‹æœŸã€‚</li><li><strong>æ­£å€¼</strong>ï¼šæ¯”è³½å·”å³°ç‹€æ…‹ã€‚</li></ul>` }
    };

    let charts = {};

    function init() {
        charts.load = echarts.init(document.getElementById('chartLoad'));
        charts.stack = echarts.init(document.getElementById('chartStack'));
        charts.trend = echarts.init(document.getElementById('chartTrend'));
        charts.body = echarts.init(document.getElementById('chartBody'));
        charts.pie = echarts.init(document.getElementById('chartPie'));
        
        window.addEventListener('resize', () => Object.values(charts).forEach(c => c.resize()));
        document.getElementById('pieMonthSelect').onchange = updatePie;

        fetchData();
    }

    function showInfo(type) {
        const modal = document.getElementById('infoModal');
        document.getElementById('modalTitle').innerText = infoData[type].title;
        document.getElementById('modalContent').innerHTML = infoData[type].content;
        modal.style.display = 'flex';
    }
    function closeInfo(e) {
        if (e.target.id === 'infoModal') document.getElementById('infoModal').style.display = 'none';
    }
    window.showInfo = showInfo;
    window.closeInfo = closeInfo;

    // [ä¿®æ­£] é£²é£Ÿå»ºè­°æ›´äººæ€§åŒ–ï¼Œç†±é‡è¨ˆç®—æ›´å¯¬å®¹
    function updateNutrition(mode, btn) {
        document.querySelectorAll('.n-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const resultDiv = document.getElementById('nutriResult');
        const elCal = document.getElementById('targetCal');
        const elPro = document.getElementById('targetProtein');
        const elAdvice = document.getElementById('targetAdvice');
        
        resultDiv.style.display = 'block';
        
        const bmr = latestBodyStats.bmr;
        const weight = latestBodyStats.weight;
        const proteinTarget = Math.round(weight * 2.0); 
        
        elPro.innerText = proteinTarget;

        let cal = 0;
        let adviceHTML = "";

        if (mode === 'high') {
            cal = Math.round(bmr + 1000);
            adviceHTML = `
                <p><span class="n-tag" style="background:#fee2e2;color:#ef4444">ç¢³æ°´ç­–ç•¥</span> <strong>é«˜ç¢³æ—¥</strong>ï¼šè«‹ç”¨åŠ›åƒé£¯ï¼è¨“ç·´å‰åƒè¶³æ¾±ç²‰ï¼Œ<strong>è¨“ç·´ä¸­åŠ è‘¡è„ç³–</strong>ã€‚</p>
                <p><span class="n-tag" style="background:#f1f5f9;color:#64748b">é”æ¨™æŠ€å·§</span> é£¯å¾Œåƒé»å …æœã€å…¨è„‚ç‰›å¥¶æˆ–èµ·å¸ï¼Œè¼•é¬†è£œç†±é‡ã€‚</p>`;
        } else if (mode === 'mid') {
            cal = Math.round(bmr + 500);
            adviceHTML = `
                <p><span class="n-tag" style="background:#fef3c7;color:#d97706">ç¢³æ°´ç­–ç•¥</span> <strong>ä¸­ç¢³æ—¥</strong>ï¼šæ¾±ç²‰é›†ä¸­åœ¨<strong>è¨“ç·´å‰å¾Œ</strong>åƒã€‚å…¶ä»–é¤åƒ 1 æ‹³é ­æ¾±ç²‰å³å¯ã€‚</p>
                <p><span class="n-tag" style="background:#f1f5f9;color:#64748b">å®µå¤œ</span> åƒè‚‰èœ + å°‘é‡å …æœã€‚</p>`;
        } else {
            cal = Math.round(bmr * 1.2);
            adviceHTML = `
                <p><span class="n-tag" style="background:#dcfce7;color:#10b981">ç¢³æ°´ç­–ç•¥</span> <strong>ä½ç¢³æ—¥</strong>ï¼šä¸ç”¨æ–·ç¢³ï¼Œ<strong>æ¯é¤åŠç¢—é£¯/åœ°ç“œ</strong>å³å¯ã€‚å¤šåƒè‚‰èœã€‚</p>
                <p><span class="n-tag" style="background:#f1f5f9;color:#64748b">æé†’</span> é¤“çš„è©±åƒå¤§ä»½é‡è”¬èœæˆ–å–è±†æ¼¿ã€‚</p>`;
        }
        
        elCal.innerText = cal;
        elAdvice.innerHTML = adviceHTML;
    }
    window.updateNutrition = updateNutrition;

    function fetchData() {
        const loadingEl = document.getElementById('loadingStatus');
        const targetUrl = YOUR_SHEET_URL + '&t=' + Date.now();
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

        fetch(proxyUrl)
            .then(response => {
                if (!response.ok) throw new Error("è®€å–éŒ¯èª¤");
                return response.text();
            })
            .then(csvText => {
                parseCSV_Full(csvText);
                
                if (weeklyData.length === 0 && rawData.length > 0) weeklyData = rawData.map(d => ({...d, load: 0}));
                if (rawData.length === 0 && weeklyData.length === 0) throw new Error("ç„¡æœ‰æ•ˆæ•¸æ“š");

                loadingEl.innerHTML = `âœ… æ•¸æ“šå·²åŒæ­¥ (æœˆç´€éŒ„:${rawData.length}ç­† / é€±ç´€éŒ„:${weeklyData.length}ç­†)`;
                loadingEl.style.color = "#86efac";
                
                document.getElementById('userBaseInfo').innerText = `é«”é‡: ${latestBodyStats.weight}kg / BMR: ${latestBodyStats.bmr} (æ›´æ–°: ${latestBodyStats.date})`;
                
                updateUI();
            })
            .catch(error => {
                console.error(error);
                loadingEl.innerText = "âš ï¸ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                loadingEl.style.color = "#fca5a5";
            });
    }

    function getStandardDate(dateStr) {
        if (!dateStr) return null;
        let s = dateStr.split(' - ')[0].trim();
        s = s.replace(/-/g, '/'); 
        let parts = s.split('/');
        if (parts.length === 3) return `${parseInt(parts[0])}/${parseInt(parts[1])}/${parseInt(parts[2])}`;
        return null;
    }

    function parseCSV_Full(text) {
        const lines = text.trim().split(/\r\n|\n/);
        
        let monthlyStartCol = -1;
        let weeklyDateCol = -1; let weeklyLoadCol = -1;
        let readinessDateCol = -1; let readinessValCol = -1;
        let bodyDateCol = -1, bodyWeightCol = -1, bodyFatCol = -1, bodyMuscleCol = -1, bodyVisceralCol = -1, bodyBmrCol = -1, bodyDeviceCol = -1;
        
        let headerRowIndex = -1;
        let headerRow = [];

        for(let i=0; i<Math.min(15, lines.length); i++) {
            const row = lines[i].split(',').map(s => s.trim());
            
            if (monthlyStartCol === -1) {
                const idx = row.indexOf('æ­¦è¡“');
                if (idx > -1) { monthlyStartCol = idx; headerRowIndex = i; headerRow = row; }
            }
            if (weeklyLoadCol === -1) {
                const idx = row.findIndex(s => s.toLowerCase() === 'srpe');
                if (idx > -1) { weeklyLoadCol = idx; weeklyDateCol = idx - 1; }
            }
            if (readinessValCol === -1) {
                const idx = row.findIndex(s => s.toLowerCase().includes('readiness'));
                if (idx > -1) { readinessValCol = idx; readinessDateCol = idx - 1; }
            }
            if (bodyWeightCol === -1) {
                const idx = row.indexOf('é«”é‡');
                if (idx > -1) {
                    bodyWeightCol = idx;
                    bodyDateCol = row.indexOf('æ—¥æœŸ', idx - 5); 
                    if(bodyDateCol === -1) bodyDateCol = idx - 1;
                    bodyFatCol = row.indexOf('é«”è„‚ç‡');
                    bodyMuscleCol = row.indexOf('è‚Œè‚‰é‡');
                    bodyVisceralCol = row.indexOf('å…§è‡Ÿè„‚è‚ª');
                    bodyBmrCol = row.indexOf('BMR');
                    bodyDeviceCol = row.indexOf('æ¸¬é‡æ©Ÿç¨®');
                }
            }
        }

        rawData = [];
        let tempWeekly = {};
        bodyData = []; 

        let startRow = (headerRowIndex === -1) ? 1 : headerRowIndex + 1;
        
        for (let i = startRow; i < lines.length; i++) {
            const row = lines[i].split(',');

            if (monthlyStartCol > -1 && row[0] && row[0].trim().startsWith('20')) {
                const mDate = row[0].trim();
                let obj = { month: mDate };
                categories.forEach((cat) => {
                    let colIdx = -1;
                    for(let k=0; k < headerRow.length; k++) {
                        if(headerRow[k] === cat && (weeklyDateCol === -1 || k < weeklyDateCol)) {
                            colIdx = k; break;
                        }
                    }
                    if (colIdx > -1) obj[cat] = row[colIdx] ? (parseInt(row[colIdx]) || 0) : 0;
                    else obj[cat] = 0;
                });
                rawData.push(obj);
            }

            if (weeklyDateCol > -1 && row[weeklyDateCol]) {
                const wDateRaw = row[weeklyDateCol].trim();
                if (wDateRaw.startsWith('20')) {
                    let stdDate = getStandardDate(wDateRaw);
                    if (stdDate) {
                        if (!tempWeekly[stdDate]) tempWeekly[stdDate] = { month: stdDate, load: 0, readiness: null };
                        let loadVal = row[weeklyLoadCol] ? parseInt(row[weeklyLoadCol]) : 0;
                        tempWeekly[stdDate].load = loadVal;
                    }
                }
            }

            if (readinessDateCol > -1 && row[readinessDateCol]) {
                const rDateRaw = row[readinessDateCol].trim();
                if (rDateRaw.startsWith('20')) {
                    let stdDate = getStandardDate(rDateRaw);
                    if (stdDate) {
                        if (!tempWeekly[stdDate]) tempWeekly[stdDate] = { month: stdDate, load: 0, readiness: null };
                        let rValStr = row[readinessValCol] ? row[readinessValCol].trim().replace('%','') : "";
                        let rVal = parseFloat(rValStr);
                        if (!isNaN(rVal)) {
                            tempWeekly[stdDate].readiness = rVal;
                        }
                    }
                }
            }

            if (bodyDateCol > -1 && row[bodyDateCol]) {
                const bDateRaw = row[bodyDateCol].trim();
                if (bDateRaw.startsWith('20')) {
                    let stdDate = getStandardDate(bDateRaw);
                    if (stdDate) {
                        let obj = {
                            date: stdDate,
                            weight: parseFloat(row[bodyWeightCol]) || 0,
                            fat: parseFloat(row[bodyFatCol] ? row[bodyFatCol].replace('%','') : 0) || 0,
                            muscle: parseFloat(row[bodyMuscleCol]) || 0,
                            visceral: parseFloat(row[bodyVisceralCol]) || 0,
                            bmr: parseInt(row[bodyBmrCol]) || 0,
                            device: row[bodyDeviceCol] ? row[bodyDeviceCol].trim() : 'Unknown'
                        };
                        if (obj.weight > 0) bodyData.push(obj);
                    }
                }
            }
        }

        weeklyData = Object.values(tempWeekly).sort((a, b) => new Date(a.month) - new Date(b.month));
        rawData.sort((a, b) => a.month.localeCompare(b.month));
        
        bodyData.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (bodyData.length > 0) {
            const last = bodyData[bodyData.length - 1];
            latestBodyStats = { bmr: last.bmr, weight: last.weight, date: last.date };
        }
    }

    function updateUI() {
        renderCharts();
        updateSelect();
    }

    function updateSelect() {
        const s = document.getElementById('pieMonthSelect');
        const oldVal = s.value;
        s.innerHTML = rawData.map(d => `<option value="${d.month}">${d.month}</option>`).join('');
        s.value = rawData.some(d => d.month === oldVal) ? oldVal : (rawData[rawData.length-1]?.month || '');
        updatePie();
    }

    function analyzeCurrentStatus(latestLoad, latestACWR, latestTSB, latestHRV, latestDate) {
        const card = document.getElementById('analysisCard');
        const badge = document.getElementById('analysisBadge');
        const txtAdvice = document.getElementById('valAdvice');
        const boxLoad = document.getElementById('valLoad');
        const boxAcwr = document.getElementById('valAcwr');
        const boxHrv = document.getElementById('valHrv');
        const boxTsb = document.getElementById('valTsb');
        
        card.style.display = 'block';
        
        let startDate = new Date(latestDate);
        let endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        let endStr = startDate.getFullYear() === endDate.getFullYear() ? `${endDate.getMonth() + 1}/${endDate.getDate()}` : `${endDate.getFullYear()}/${endDate.getMonth() + 1}/${endDate.getDate()}`;
        document.getElementById('analysisDate').innerText = `æœ¬é€±åˆ†æ (${latestDate} ~ ${endStr})`;

        boxLoad.innerText = Math.round(latestLoad);
        boxAcwr.innerText = latestACWR || '--';
        boxAcwr.style.color = latestACWR > 1.5 ? '#dc2626' : (latestACWR >= 1.3 ? '#d97706' : '#059669');
        boxHrv.innerText = latestHRV ? latestHRV + '%' : '--';
        if (latestHRV) boxHrv.style.color = latestHRV < 60 ? '#dc2626' : (latestHRV < 75 ? '#d97706' : '#059669');
        let tsbSign = latestTSB > 0 ? "+" : "";
        boxTsb.innerText = tsbSign + latestTSB;
        boxTsb.style.color = latestTSB >= 0 ? '#059669' : '#dc2626';

        let status = "æ™®é€š", color = "#475569", advice = "";
        if (latestACWR > 1.3 && latestHRV && latestHRV < 65) { status = '<span class="status-dot"></span> é«˜é¢¨éšª'; color = "#dc2626"; advice = "<strong>âš ï¸ è­¦å‘Šï¼š</strong>å¼·åº¦å¢åŠ éå¿«ä¸”æ¢å¾©ä¸ä½³ã€‚æœ¬é€±å»ºè­°<strong>å¼·åˆ¶æ¸›é‡</strong>ï¼Œé¿å…å—å‚·ã€‚"; }
        else if (latestACWR > 1.3) { status = '<span class="status-dot"></span> è­¦æˆ’ä¸­'; color = "#d97706"; advice = "<strong>ğŸ’ª è¡åˆºæœŸï¼š</strong>è² è·è¼ƒé«˜ï¼Œèº«é«”å°šå¯æ”¯æ’ã€‚è«‹ç¹¼çºŒè¨“ç·´ï¼Œä½†å‹™å¿…<strong>ç¢ºä¿ç¡çœ </strong>ã€‚"; }
        else if (latestHRV && latestHRV < 60) { status = '<span class="status-dot"></span> éœ€æ¢å¾©'; color = "#d97706"; advice = "<strong>ğŸ›Œ èº«é«”äº®ç´…ç‡ˆï¼š</strong>éè¨“ç·´å› ç´ å°è‡´çš„ç–²å‹ã€‚<strong>è«‹ä¼‘æ¯ï¼Œä¸è¦è£œç·´</strong>ã€‚"; }
        else if (latestHRV && latestHRV >= 75) { status = '<span class="status-dot"></span> ç‹€æ…‹çµ•ä½³'; color = "#059669"; advice = "<strong>ğŸš€ ç¶ ç‡ˆå…¨é–‹ï¼š</strong>é©åˆæŒ‘æˆ°<strong>é«˜å¼·åº¦æˆ–å¤§é‡é‡</strong>ã€‚"; }
        else { status = '<span class="status-dot"></span> ç©©å®šç´¯ç©'; color = "#2563eb"; advice = "è¨“ç·´èˆ‡æ¢å¾©å¹³è¡¡ã€‚ç¶­æŒç›®å‰ç¯€å¥ï¼Œç©©ç´®ç©©æ‰“ã€‚"; }

        badge.innerHTML = status; badge.style.backgroundColor = color; 
        txtAdvice.innerHTML = advice;
    }

    function renderCharts() {
        const weeklyTimeline = weeklyData.map(d => d.month.split(' - ')[0]);
        const acuteLoads = weeklyData.map(d => d.load);
        const chronicLoads = acuteLoads.map((val, idx) => {
            const startIdx = Math.max(0, idx - 3);
            const subset = acuteLoads.slice(startIdx, idx + 1);
            const sum = subset.reduce((a, b) => a + b, 0);
            return sum / subset.length;
        });
        const acwrData = acuteLoads.map((acute, idx) => {
            const chronic = chronicLoads[idx];
            if (chronic === 0) return 0;
            return parseFloat((acute / chronic).toFixed(2));
        });
        const tsbData = acuteLoads.map((acute, idx) => {
            const chronic = chronicLoads[idx];
            return Math.round(chronic - acute);
        });
        const readinessData = weeklyData.map(d => d.readiness);

        if (weeklyData.length > 0) {
            const lastIdx = weeklyData.length - 1;
            analyzeCurrentStatus(acuteLoads[lastIdx], acwrData[lastIdx], tsbData[lastIdx], readinessData[lastIdx], weeklyTimeline[lastIdx]);
        }

        const startValueWeekly = Math.max(0, weeklyTimeline.length - 6);

        // [ä¿®æ­£] è² è·åœ–ï¼šgrid.left æ‰‹å‹•è¨­å°ä¸€é»ä»¥æ¸›å°‘ç•™ç™½ï¼Œå³é‚Šç‚º0
        charts.load.setOption({
            tooltip: { 
                trigger: 'item', 
                formatter: p => {
                    let name = p.name;
                    let val = p.value;
                    if(p.seriesName === 'ç¸½è² è·') return `${name}<br/>${p.marker} è² è·: <strong>${val}</strong>`;
                    if(p.seriesName === 'ACWR') return `${name}<br/>${p.marker} ACWR: <strong>${val}</strong>`;
                    if(p.seriesName === 'é æ¸¬è¡¨ç¾') return `${name}<br/>${p.marker} TSB: <strong>${val > 0 ? '+'+val : val}</strong>`;
                    if(p.seriesName === 'HRV') return `${name}<br/>${p.marker} HRV: <strong>${val}%</strong>`;
                    return `${name}<br/>${val}`;
                }
            },
            legend: { show: false },
            dataZoom: [ { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueWeekly, endValue: weeklyTimeline.length - 1, height: 20, bottom: 5, handleSize: '100%' }, { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true } ],
            grid: { top: 30, bottom: 35, left: '10%', right: '0%', containLabel: false },
            xAxis: { type: 'category', data: weeklyTimeline, axisLabel: { fontSize: 10, color: '#64748b', showMaxLabel: true } },
            yAxis: [ { type: 'value', splitLine: { show: false } }, { type: 'value', min: 0, max: 2.5, show: false }, { type: 'value', min: 0, max: 100, show: false }, { type: 'value', show: false } ],
            series: [
                { name: 'ç¸½è² è·', type: 'bar', data: acuteLoads, yAxisIndex: 0, emphasis: { focus: 'self' }, itemStyle: { color: '#1e293b', borderRadius: [4, 4, 0, 0] } },
                { name: 'ACWR', type: 'line', yAxisIndex: 1, data: acwrData, smooth: true, itemStyle: { color: '#f59e0b' }, lineStyle: { width: 3 }, emphasis: { focus: 'self' }, markArea: { silent: true, data: [ [{ yAxis: 0.8, itemStyle: { color: 'rgba(16, 185, 129, 0.4)' } }, { yAxis: 1.3 }], [{ yAxis: 1.3, itemStyle: { color: 'rgba(245, 158, 11, 0.4)' } }, { yAxis: 1.5 }], [{ yAxis: 1.5, itemStyle: { color: 'rgba(239, 68, 68, 0.4)' } }, { yAxis: 3.0 }] ] } },
                { name: 'é æ¸¬è¡¨ç¾', type: 'line', yAxisIndex: 3, data: tsbData, smooth: true, showSymbol: false, lineStyle: { width: 2, color: '#8b5cf6' }, emphasis: { focus: 'self' }, markLine: { silent: true, symbol: 'none', lineStyle: { type: 'solid', color: 'rgba(139, 92, 246, 0.5)', width: 1 }, data: [ { yAxis: 0 } ] }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [ { offset: 0, color: 'rgba(139, 92, 246, 0.3)' }, { offset: 1, color: 'rgba(139, 92, 246, 0)' } ]) } },
                { name: 'HRV', type: 'line', yAxisIndex: 2, data: readinessData, smooth: true, symbol: 'circle', symbolSize: 4, connectNulls: true, itemStyle: { color: '#ec4899' }, lineStyle: { width: 2, type: 'dashed', color: '#ec4899' }, emphasis: { focus: 'self' } }
            ]
        });

        // [ä¿®æ­£] é«”æ…‹åœ–è¡¨ï¼štrigger: 'axis' ä¸” confine: true
        const tanitaData = bodyData.filter(d => d.device.toUpperCase().includes('TANITA'));
        const bodyDates = tanitaData.map(d => d.date);
        
        charts.body.setOption({
            tooltip: { trigger: 'axis', confine: true, axisPointer: { type: 'cross' } },
            legend: { show: true, top: 0, type: 'scroll' },
            grid: { top: 30, bottom: 20, left: '10%', right: '10%', containLabel: true },
            dataZoom: [ { type: 'inside', xAxisIndex: [0] } ],
            xAxis: { type: 'category', data: bodyDates, axisLabel: { fontSize: 10, color: '#64748b' } },
            yAxis: [
                { type: 'value', name: 'Kg', position: 'left', splitLine: { show: false } },
                { type: 'value', name: '%', position: 'right', min: 10, max: 30, splitLine: { lineStyle: { type: 'dashed', color: '#f1f5f9' } } }
            ],
            series: [
                { 
                    name: 'è‚Œè‚‰é‡ (kg)', type: 'line', data: tanitaData.map(d => d.muscle), 
                    smooth: true, itemStyle: { color: '#3b82f6' }, lineStyle: { width: 3 },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(59,130,246,0.2)'}, {offset: 1, color: 'rgba(59,130,246,0)'}]) },
                    emphasis: { focus: 'series' }
                },
                { 
                    name: 'é«”è„‚ç‡ (%)', type: 'line', yAxisIndex: 1, data: tanitaData.map(d => d.fat), 
                    smooth: true, itemStyle: { color: '#ef4444' }, lineStyle: { width: 2, type: 'dashed' },
                    emphasis: { focus: 'series' }
                },
                { 
                    name: 'é«”é‡ (kg)', type: 'line', data: tanitaData.map(d => d.weight), 
                    smooth: true, itemStyle: { color: '#333' }, lineStyle: { width: 1, type: 'dotted' },
                    emphasis: { focus: 'series' }
                }
            ]
        });

        // è¶¨å‹¢åœ– [ä¿®æ­£] trigger: 'axis', confine: true
        const commonXMonthly = { type: 'category', data: rawData.map(d => d.month), axisLabel: { fontSize: 10, color: '#64748b' } };
        const totals = rawData.map(d => categories.reduce((s, c) => s + d[c], 0));
        const startValueMonthly = Math.max(0, rawData.length - 6);

        charts.stack.setOption({
            color: colors, 
            tooltip: { trigger: 'item', formatter: p => `${p.seriesName} (${p.name})<br/><strong>${Math.floor(p.value/60)}å°æ™‚ ${p.value%60}åˆ†</strong>` },
            legend: { top: 0, type: 'scroll', data: categories },
            dataZoom: [ { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueMonthly, endValue: rawData.length - 1, height: 20, bottom: 5, handleSize: '100%' }, { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true } ],
            grid: { top: 40, bottom: 35, left: 35, right: 15, containLabel: true },
            xAxis: commonXMonthly, yAxis: { type: 'value' },
            series: categories.map((cat, ci) => ({ name: cat, type: 'bar', stack: 'total', emphasis: { focus: 'series' }, data: rawData.map((d, mi) => { let isTop = true; for(let k=ci+1; k<categories.length; k++) if(rawData[mi][categories[k]] > 0) { isTop = false; break; } return { value: d[cat], itemStyle: { borderRadius: (isTop && d[cat]>0) ? [4,4,0,0] : 0 } }; }), label: ci === categories.length - 1 ? { show: true, position: 'top', formatter: p => (totals[p.dataIndex]/60).toFixed(1)+'h', fontSize: 10, color: '#64748b' } : { show: false } }))
        });

        charts.trend.setOption({
            color: colors,
            tooltip: { trigger: 'axis', confine: true }, // [ä¿®æ­£]
            legend: { top: 0, type: 'scroll', data: categories },
            dataZoom: [ { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueMonthly, endValue: rawData.length - 1, height: 20, bottom: 5, handleSize: '100%' }, { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true } ],
            grid: { top: 40, bottom: 35, left: 35, right: 10, containLabel: true },
            xAxis: { ...commonXMonthly, boundaryGap: false }, yAxis: { type: 'value' },
            series: categories.map((c, i) => ({ name: c, type: 'line', smooth: true, data: rawData.map(d => d[c]), emphasis: { focus: 'series', lineStyle: { width: 4 } } }))
        });
    }

    function updatePie() {
        const m = document.getElementById('pieMonthSelect').value;
        const d = rawData.find(x => x.month === m);
        if(!d) return;
        charts.pie.setOption({
            color: colors,
            tooltip: { trigger: 'item', formatter: p => `${p.name}<br/>${Math.floor(p.value/60)}æ™‚${p.value%60}åˆ† (${p.percent}%)` },
            series: [{ type: 'pie', radius: ['40%', '70%'], label: { show: true, formatter: '{b}\n{d}%' }, data: categories.map((c, i) => ({ name: c, value: d[c] })).filter(v => v.value > 0) }]
        });
    }

    window.onload = init;
</script>
</body>
</html>