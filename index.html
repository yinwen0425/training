<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººé‹å‹•è¨“ç·´æ•¸æ“šå„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #f1f5f9;
            --text: #1e293b;
            --card-bg: #ffffff;
            --header-dark: #1e293b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 10px;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--header-dark), #334155);
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header h1 { margin: 0; font-size: 20px; letter-spacing: 1px; }
        .loading-text { margin-top: 8px; font-size: 13px; color: #cbd5e1; }

        /* æˆ°æƒ…åˆ†æå¡æ¨£å¼ */
        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 6px solid #ccc; 
            transition: all 0.3s ease;
        }
        .analysis-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        
        /* [ä¿®æ”¹] ç‹€æ…‹æ¨™ç±¤æ¨£å¼ï¼šåŠ å…¥ Flex è®“åœ“é»å°é½Šï¼Œä¸¦å¾®èª¿é™°å½± */
        .analysis-status { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 6px; /* åœ“é»è·Ÿæ–‡å­—çš„è·é›¢ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* [æ–°å¢] ç‹€æ…‹ç‡ˆè™Ÿï¼šçµ±ä¸€ç‚ºç™½è‰²åœ“é»ï¼Œç¢ºä¿åœ¨æ·±è‰²èƒŒæ™¯æœ€æ¸…æ™° */
        .status-dot {
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            display: inline-block;
        }
        
        .analysis-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        @media (min-width: 640px) { .analysis-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .metric-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; }
        .metric-label { font-size: 11px; color: #64748b; margin-bottom: 2px; }
        .metric-value { font-size: 16px; font-weight: bold; color: #334155; }
        .metric-unit { font-size: 10px; color: #94a3b8; }

        .advice-box { background: #f0f9ff; padding: 15px; border-radius: 8px; font-size: 14px; color: #0c4a6e; line-height: 1.5; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        .chart-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 380px; display: flex; flex-direction: column; }
        .chart-container { flex: 1; width: 100%; min-height: 0; }
        
        h2 { font-size: 15px; margin: 0 0 10px; border-left: 4px solid var(--primary); padding-left: 10px; color: var(--text); display: flex; align-items: center; justify-content: space-between; }
        select { font-size: 12px; padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        .legend-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #64748b; margin-bottom: 5px; background: #f8fafc; padding: 6px 8px; border-radius: 4px; flex-wrap: wrap; gap: 5px; }
        .legend-group { display: flex; gap: 8px; align-items: center; }
        .legend-item { display: flex; align-items: center; white-space: nowrap; }

        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 3px; display: inline-block; }
        .dot-green { background: #dcfce7; border: 1px solid #10b981; }
        .dot-yellow { background: #fef9c3; border: 1px solid #f59e0b; }
        .dot-red { background: #fee2e2; border: 1px solid #ef4444; }

        .icon-bar { width: 10px; height: 8px; background: #1e293b; border-radius: 2px; margin-right: 3px; display: inline-block; }
        .icon-line-acwr { width: 10px; height: 2px; background: #f59e0b; margin-right: 3px; display: inline-block; position: relative; top: -1px; }
        .icon-line-acwr::after { content: ''; position: absolute; width: 4px; height: 4px; background: #fff; border: 1px solid #f59e0b; border-radius: 50%; top: -2px; left: 3px; }
        .icon-line-perf { width: 10px; height: 2px; background: #8b5cf6; margin-right: 3px; display: inline-block; position: relative; top: -1px; } 
        .icon-line-hrv { width: 10px; height: 2px; border-bottom: 2px dashed #ec4899; margin-right: 3px; display: inline-block; position: relative; top: -2px; } 
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>é‹å‹•è¨“ç·´æ•¸æ“šå„€è¡¨æ¿</h1>
        <div id="loadingStatus" class="loading-text">æ­£åœ¨é€£ç·š Google Sheets...</div>
    </div>

    <!-- æœ¬é€±æˆ°æƒ…åˆ†æå¡ -->
    <div id="analysisCard" class="analysis-section" style="display:none;">
        <div class="analysis-title">
            <span id="analysisDate">æœ¬é€±ç‹€æ³åˆ†æ</span>
            <!-- é€™è£¡çš„å…§å®¹æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
            <div id="analysisBadge" class="analysis-status">è¨ˆç®—ä¸­</div>
        </div>
        <div class="analysis-grid">
            <div class="metric-box">
                <div class="metric-label">æœ¬é€±è² è·</div>
                <div class="metric-value" id="valLoad">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">ACWR é¢¨éšª</div>
                <div class="metric-value" id="valAcwr">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">HRV ç‹€æ…‹</div>
                <div class="metric-value" id="valHrv">--</div>
                <div class="metric-unit">é€±å¹³å‡</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">é æ¸¬è¡¨ç¾</div>
                <div class="metric-value" id="valTsb">--</div>
            </div>
        </div>
        <div class="advice-box" id="valAdvice">
            æ­£åœ¨åˆ†ææ•¸æ“š...
        </div>
    </div>

    <div class="grid">
        <div class="chart-card">
            <h2>è¨“ç·´è² è·</h2>
            <div class="legend-row">
                <div class="legend-group">
                    <div class="legend-item"><span class="dot dot-green"></span>æœ€ä½³</div>
                    <div class="legend-item"><span class="dot dot-yellow"></span>è­¦æˆ’</div>
                    <div class="legend-item"><span class="dot dot-red"></span>å±éšª</div>
                </div>
                <div class="legend-group">
                    <div class="legend-item"><span class="icon-bar"></span>ç¸½è² è·</div>
                    <div class="legend-item"><span class="icon-line-acwr"></span>ACWR</div>
                    <div class="legend-item"><span class="icon-line-perf"></span>é æ¸¬è¡¨ç¾</div>
                    <div class="legend-item"><span class="icon-line-hrv"></span>HRV</div>
                </div>
            </div>
            <div id="chartLoad" class="chart-container"></div>
        </div>
        <div class="chart-card"><h2>è¨“ç·´çµæ§‹</h2><div id="chartStack" class="chart-container"></div></div>
        <div class="chart-card"><h2>è¨“ç·´è¶¨å‹¢</h2><div id="chartTrend" class="chart-container"></div></div>
        <div class="chart-card">
            <h2>è¨“ç·´åˆ†æ <select id="pieMonthSelect"></select></h2>
            <div id="chartPie" class="chart-container"></div>
        </div>
    </div>
</div>

<script>
    const YOUR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfKipyUTKtVPZ4HUcse4iJZjkD5fw_3HzmMgkCfi6UDphbjOZidlqMXFuGOhu0FiJCLzJcKtgt2Dqy/pub?gid=1055429386&single=true&output=csv';

    let rawData = [];
    let weeklyData = [];

    const categories = ['æ­¦è¡“', 'æ ¼é¬¥', 'å°ç·´', 'å¥èº«', 'HIIT', 'Zone 2'];
    const colors = ['#F43F5E', '#2563EB', '#8B5CF6', '#F59E0B', '#0EA5E9', '#10B981'];
    const intensityWeights = { 'æ­¦è¡“': 1.0, 'æ ¼é¬¥': 1.5, 'å¥èº«': 1.2, 'å°ç·´': 1.8, 'HIIT': 2.0, 'Zone 2': 0.8 };
    
    let charts = {};

    function init() {
        charts.load = echarts.init(document.getElementById('chartLoad'));
        charts.stack = echarts.init(document.getElementById('chartStack'));
        charts.trend = echarts.init(document.getElementById('chartTrend'));
        charts.pie = echarts.init(document.getElementById('chartPie'));
        
        window.addEventListener('resize', () => Object.values(charts).forEach(c => c.resize()));
        document.getElementById('pieMonthSelect').onchange = updatePie;

        fetchData();
    }

    function fetchData() {
        const loadingEl = document.getElementById('loadingStatus');
        const targetUrl = YOUR_SHEET_URL + '&t=' + Date.now();
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

        fetch(proxyUrl)
            .then(response => {
                if (!response.ok) throw new Error("è®€å–éŒ¯èª¤");
                return response.text();
            })
            .then(csvText => {
                parseSideBySideCSV(csvText);
                
                if (weeklyData.length === 0 && rawData.length > 0) {
                    weeklyData = rawData;
                }

                if (rawData.length === 0) throw new Error("ç„¡æœ‰æ•ˆæ•¸æ“š");

                loadingEl.innerHTML = `âœ… æ•¸æ“šå·²åŒæ­¥ (æœˆç´€éŒ„:${rawData.length}ç­† / é€±ç´€éŒ„:${weeklyData.length}ç­†)`;
                loadingEl.style.color = "#86efac";
                updateUI();
            })
            .catch(error => {
                console.error(error);
                loadingEl.innerText = "âš ï¸ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                loadingEl.style.color = "#fca5a5";
            });
    }

    function getStandardDate(dateStr) {
        if (!dateStr) return null;
        let s = dateStr.split(' - ')[0].trim();
        s = s.replace(/-/g, '/'); 
        let parts = s.split('/');
        if (parts.length === 3) {
            return `${parseInt(parts[0])}/${parseInt(parts[1])}/${parseInt(parts[2])}`;
        }
        return null;
    }

    function parseSideBySideCSV(text) {
        const lines = text.trim().split(/\r\n|\n/);
        
        let headerIndex = -1;
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('æ­¦è¡“')) { headerIndex = i; break; }
        }
        if (headerIndex === -1) return;

        const headerRow = lines[headerIndex].split(',').map(h => h.trim());
        
        let leftStartCol = -1;
        let rightStartCol = -1;
        let readinessDateCol = -1;
        let readinessValCol = -1;

        let wushuIndices = [];
        headerRow.forEach((val, idx) => { if (val === 'æ­¦è¡“') wushuIndices.push(idx); });

        if (wushuIndices.length > 0) leftStartCol = wushuIndices[0] - 1;
        if (wushuIndices.length > 1) rightStartCol = wushuIndices[1] - 1;

        let searchRows = [headerRow];
        if (headerIndex > 0) {
            searchRows.push(lines[headerIndex - 1].split(',').map(h => h.trim()));
        }

        for (let row of searchRows) {
            let rIndex = row.findIndex(h => h.toLowerCase().includes('readiness'));
            if (rIndex > -1) {
                readinessValCol = rIndex;
                readinessDateCol = rIndex - 1; 
                break; 
            }
        }

        rawData = [];     
        let tempWeekly = []; 
        let tempReadiness = {}; 

        for (let i = headerIndex + 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            
            if (leftStartCol >= 0 && row[leftStartCol] && row[leftStartCol].trim().startsWith('20')) {
                let obj = { month: row[leftStartCol].trim() };
                categories.forEach((cat, offset) => {
                    let val = row[leftStartCol + 1 + offset];
                    obj[cat] = val ? (parseInt(val) || 0) : 0;
                });
                rawData.push(obj);
            }

            if (rightStartCol >= 0 && row[rightStartCol] && row[rightStartCol].trim().startsWith('20')) {
                let dateStr = row[rightStartCol].trim();
                let obj = { month: dateStr };
                categories.forEach((cat, offset) => {
                    let val = row[rightStartCol + 1 + offset];
                    obj[cat] = val ? (parseInt(val) || 0) : 0;
                });
                tempWeekly.push(obj);
            }

            if (readinessDateCol >= 0 && row[readinessDateCol]) {
                let rDateRaw = row[readinessDateCol].trim();
                let rValStr = row[readinessValCol] ? row[readinessValCol].trim() : "";
                
                if (rDateRaw.startsWith('20') && rValStr) {
                    let stdDate = getStandardDate(rDateRaw);
                    let rVal = parseFloat(rValStr.replace('%', ''));
                    if (stdDate && !isNaN(rVal)) {
                        tempReadiness[stdDate] = rVal;
                    }
                }
            }
        }

        weeklyData = tempWeekly.map(d => {
            let stdKey = getStandardDate(d.month);
            return {
                ...d,
                readiness: (stdKey && tempReadiness[stdKey] !== undefined) ? tempReadiness[stdKey] : null
            };
        });
        
        const dateSorter = (a, b) => {
            let dateA = new Date(getStandardDate(a.month));
            let dateB = new Date(getStandardDate(b.month));
            return dateA - dateB;
        };

        rawData.sort(dateSorter);
        weeklyData.sort(dateSorter);
    }

    function updateUI() {
        renderCharts();
        updateSelect();
    }

    function updateSelect() {
        const s = document.getElementById('pieMonthSelect');
        const oldVal = s.value;
        s.innerHTML = rawData.map(d => `<option value="${d.month}">${d.month}</option>`).join('');
        s.value = rawData.some(d => d.month === oldVal) ? oldVal : (rawData[rawData.length-1]?.month || '');
        updatePie();
    }

    function analyzeCurrentStatus(latestLoad, latestACWR, latestTSB, latestHRV, latestDate) {
        const card = document.getElementById('analysisCard');
        const badge = document.getElementById('analysisBadge');
        const txtAdvice = document.getElementById('valAdvice');
        const boxLoad = document.getElementById('valLoad');
        const boxAcwr = document.getElementById('valAcwr');
        const boxHrv = document.getElementById('valHrv');
        const boxTsb = document.getElementById('valTsb');
        
        card.style.display = 'block';
        document.getElementById('analysisDate').innerText = `æœ¬é€±åˆ†æ (${latestDate})`;

        boxLoad.innerText = Math.round(latestLoad);
        boxAcwr.innerText = latestACWR || '--';
        boxAcwr.style.color = latestACWR > 1.5 ? '#dc2626' : (latestACWR >= 1.3 ? '#d97706' : '#059669');
        
        boxHrv.innerText = latestHRV ? latestHRV + '%' : '--';
        if (latestHRV) {
            boxHrv.style.color = latestHRV < 60 ? '#dc2626' : (latestHRV < 75 ? '#d97706' : '#059669');
        }

        let tsbSign = latestTSB > 0 ? "+" : "";
        boxTsb.innerText = tsbSign + latestTSB;
        boxTsb.style.color = latestTSB >= 0 ? '#059669' : '#dc2626';

        let status = "æ™®é€š";
        let color = "#475569"; // Gray
        let advice = "";

        // [ä¿®æ”¹] ä½¿ç”¨ <span class="status-dot"></span> å–ä»£ Emoji
        // [ä¿®æ”¹] åŠ æ·±äº†èƒŒæ™¯è‰²ç¢¼ï¼Œç¢ºä¿ç™½å­—æ¸…æ™°å¯è¦‹
        if (latestACWR > 1.3 && latestHRV && latestHRV < 65) {
            status = '<span class="status-dot"></span> é«˜é¢¨éšª';
            color = "#dc2626"; // Red-600
            advice = "<strong>âš ï¸ è­¦å‘Šï¼š</strong>å¼·åº¦å¢åŠ éå¿«ä¸”æ¢å¾©ä¸ä½³ã€‚æœ¬é€±å»ºè­°<strong>å¼·åˆ¶æ¸›é‡</strong>ï¼Œé¿å…å—å‚·ã€‚";
        }
        else if (latestACWR > 1.3) {
            status = '<span class="status-dot"></span> è­¦æˆ’ä¸­';
            color = "#d97706"; // Amber-600 (Darker Orange)
            advice = "<strong>ğŸ’ª è¡åˆºæœŸï¼š</strong>è² è·è¼ƒé«˜ï¼Œèº«é«”å°šå¯æ”¯æ’ã€‚è«‹ç¹¼çºŒè¨“ç·´ï¼Œä½†å‹™å¿…<strong>ç¢ºä¿ç¡çœ </strong>ã€‚";
        }
        else if (latestHRV && latestHRV < 60) {
            status = '<span class="status-dot"></span> éœ€æ¢å¾©';
            color = "#d97706"; // Amber-600
            advice = "<strong>ğŸ›Œ èº«é«”äº®ç´…ç‡ˆï¼š</strong>éè¨“ç·´å› ç´ å°è‡´çš„ç–²å‹ã€‚<strong>è«‹ä¼‘æ¯ï¼Œä¸è¦è£œç·´</strong>ã€‚";
        }
        else if (latestHRV && latestHRV >= 75) {
            status = '<span class="status-dot"></span> ç‹€æ…‹çµ•ä½³';
            color = "#059669"; // Emerald-600
            advice = "<strong>ğŸš€ ç¶ ç‡ˆå…¨é–‹ï¼š</strong>èº«é«”é›»é‡å……è¶³ã€‚é©åˆæŒ‘æˆ°<strong>é«˜å¼·åº¦æˆ–å¤§é‡é‡</strong>ã€‚";
        }
        else {
            status = '<span class="status-dot"></span> ç©©å®šç´¯ç©';
            color = "#2563eb"; // Blue-600
            advice = "è¨“ç·´èˆ‡æ¢å¾©å¹³è¡¡ã€‚è«‹ç¶­æŒç›®å‰ç¯€å¥ï¼Œå°ˆæ³¨æŠ€è¡“ï¼Œç©©ç´®ç©©æ‰“ã€‚";
        }

        badge.innerHTML = status; // æ”¹ç”¨ innerHTML ä»¥æ”¯æ´ span
        badge.style.backgroundColor = color;
        card.style.borderLeftColor = color;
        txtAdvice.innerHTML = advice;
    }

    function renderCharts() {
        const weeklyTimeline = weeklyData.map(d => d.month.split(' - ')[0]);
        const acuteLoads = weeklyData.map(d => 
            categories.reduce((sum, cat) => sum + (d[cat] * intensityWeights[cat]), 0)
        );

        const chronicLoads = acuteLoads.map((val, idx) => {
            const startIdx = Math.max(0, idx - 3);
            const subset = acuteLoads.slice(startIdx, idx + 1);
            const sum = subset.reduce((a, b) => a + b, 0);
            return sum / subset.length;
        });

        const acwrData = acuteLoads.map((acute, idx) => {
            const chronic = chronicLoads[idx];
            if (chronic === 0) return 0;
            return parseFloat((acute / chronic).toFixed(2));
        });

        const tsbData = acuteLoads.map((acute, idx) => {
            const chronic = chronicLoads[idx];
            return Math.round(chronic - acute);
        });

        const readinessData = weeklyData.map(d => d.readiness);

        if (weeklyData.length > 0) {
            const lastIdx = weeklyData.length - 1;
            analyzeCurrentStatus(
                acuteLoads[lastIdx], 
                acwrData[lastIdx], 
                tsbData[lastIdx], 
                readinessData[lastIdx], 
                weeklyTimeline[lastIdx]
            );
        }

        const startValueWeekly = Math.max(0, weeklyTimeline.length - 6);

        charts.load.setOption({
            tooltip: { 
                trigger: 'axis', axisPointer: { type: 'line' },
                formatter: function (params) {
                    let date = params[0].name;
                    let result = `<strong>${date}</strong> (é€±)<br/>`;
                    params.forEach(p => {
                        if (p.seriesName === 'ç¸½è² è·') result += `è² è·: ${Math.round(p.value)}<br/>`;
                        if (p.seriesName === 'ACWR') {
                            let status = p.value > 1.5 ? "ğŸ”´" : (p.value >= 1.3 ? "ğŸŸ¡" : "ğŸŸ¢");
                            result += `ACWR: ${p.value ?? '--'} ${status}<br/>`;
                        }
                        if (p.seriesName === 'é æ¸¬è¡¨ç¾') {
                            let sign = p.value > 0 ? "+" : "";
                            let color = p.value >= 0 ? "green" : "red";
                            result += `é æ¸¬è¡¨ç¾: <span style="color:${color}">${sign}${p.value}</span><br/>`;
                        }
                        if (p.seriesName === 'HRV') result += `HRV: ${p.value !== undefined ? p.value + '%' : '--'}<br/>`;
                    });
                    return result;
                }
            },
            legend: { show: false },
            dataZoom: [
                { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueWeekly, endValue: weeklyTimeline.length - 1, height: 20, bottom: 5, handleSize: '100%' },
                { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true }
            ],
            grid: { top: 30, bottom: 35, left: 10, right: 10, containLabel: true },
            xAxis: { 
                type: 'category', 
                data: weeklyTimeline, 
                axisLabel: { fontSize: 10, color: '#64748b', showMaxLabel: true } 
            },
            yAxis: [
                { type: 'value', splitLine: { show: false } },
                { type: 'value', min: 0, max: 2.5, splitLine: { lineStyle: { type: 'dashed', color: '#f1f5f9' } }, axisLabel: { show: false } },
                { type: 'value', min: 0, max: 100, show: false },
                { type: 'value', splitLine: { show: false }, show: false }
            ],
            series: [
                { 
                    name: 'ç¸½è² è·', type: 'bar', data: acuteLoads, yAxisIndex: 0,
                    emphasis: { focus: 'self' },
                    itemStyle: { color: '#1e293b', borderRadius: [4, 4, 0, 0] } 
                },
                { 
                    name: 'ACWR', type: 'line', yAxisIndex: 1, data: acwrData, 
                    smooth: true, symbolSize: 6, 
                    itemStyle: { color: '#f59e0b' }, lineStyle: { width: 3 },
                    markArea: {
                        silent: true,
                        data: [
                            [{ yAxis: 0.8, itemStyle: { color: 'rgba(16, 185, 129, 0.4)' } }, { yAxis: 1.3 }],
                            [{ yAxis: 1.3, itemStyle: { color: 'rgba(245, 158, 11, 0.4)' } }, { yAxis: 1.5 }],
                            [{ yAxis: 1.5, itemStyle: { color: 'rgba(239, 68, 68, 0.4)' } }, { yAxis: 3.0 }]
                        ]
                    }
                },
                {
                    name: 'é æ¸¬è¡¨ç¾', type: 'line', yAxisIndex: 3, data: tsbData,
                    smooth: true, showSymbol: false,
                    lineStyle: { width: 2, color: '#8b5cf6' },
                    markLine: {
                        silent: true, symbol: 'none', label: { show: false },
                        lineStyle: { type: 'solid', color: 'rgba(139, 92, 246, 0.5)', width: 1 },
                        data: [ { yAxis: 0 } ]
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(139, 92, 246, 0.3)' },
                            { offset: 1, color: 'rgba(139, 92, 246, 0)' }
                        ])
                    }
                },
                {
                    name: 'HRV', type: 'line', yAxisIndex: 2, data: readinessData,
                    smooth: true, symbol: 'circle', symbolSize: 4,
                    connectNulls: true,
                    itemStyle: { color: '#ec4899' },
                    lineStyle: { width: 2, type: 'dashed', color: '#ec4899' } 
                }
            ]
        });

        const commonXMonthly = { type: 'category', data: rawData.map(d => d.month), axisLabel: { fontSize: 10, color: '#64748b' } };
        const totals = rawData.map(d => categories.reduce((s, c) => s + d[c], 0));
        const startValueMonthly = Math.max(0, rawData.length - 6);

        charts.stack.setOption({
            color: colors, 
            tooltip: { trigger: 'item', formatter: p => `${p.seriesName}<br/>${Math.floor(p.value/60)}h ${p.value%60}m` },
            legend: { top: 0, type: 'scroll', data: categories },
            dataZoom: [
                { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueMonthly, endValue: rawData.length - 1, height: 20, bottom: 5, handleSize: '100%' },
                { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true }
            ],
            grid: { top: 40, bottom: 35, left: 35, right: 15, containLabel: true },
            xAxis: commonXMonthly, yAxis: { type: 'value' },
            series: categories.map((cat, ci) => ({
                name: cat, type: 'bar', stack: 'total', emphasis: { focus: 'series' },
                data: rawData.map((d, mi) => {
                    let isTop = true;
                    for(let k=ci+1; k<categories.length; k++) if(rawData[mi][categories[k]] > 0) { isTop = false; break; }
                    return { value: d[cat], itemStyle: { borderRadius: (isTop && d[cat]>0) ? [4,4,0,0] : 0 } };
                }),
                label: ci === categories.length - 1 ? { show: true, position: 'top', formatter: p => (totals[p.dataIndex]/60).toFixed(1)+'h', fontSize: 10, color: '#64748b' } : { show: false }
            }))
        });

        charts.trend.setOption({
            color: colors,
            tooltip: { trigger: 'item', formatter: p => `${p.name}<br/>${p.marker} ${p.seriesName}: ${Math.floor(p.value/60)}æ™‚${p.value%60}åˆ†` },
            legend: { top: 0, type: 'scroll', data: categories },
            dataZoom: [
                { type: 'slider', show: true, xAxisIndex: [0], startValue: startValueMonthly, endValue: rawData.length - 1, height: 20, bottom: 5, handleSize: '100%' },
                { type: 'inside', xAxisIndex: [0], zoomOnMouseWheel: false, moveOnMouseWheel: true }
            ],
            grid: { top: 40, bottom: 35, left: 35, right: 10, containLabel: true },
            xAxis: { ...commonXMonthly, boundaryGap: false }, yAxis: { type: 'value' },
            series: categories.map((c, i) => ({ name: c, type: 'line', smooth: true, data: rawData.map(d => d[c]), emphasis: { focus: 'series', lineStyle: { width: 4 } } }))
        });
    }

    function updatePie() {
        const m = document.getElementById('pieMonthSelect').value;
        const d = rawData.find(x => x.month === m);
        if(!d) return;
        charts.pie.setOption({
            color: colors,
            tooltip: { trigger: 'item', formatter: p => `${p.name}<br/>${Math.floor(p.value/60)}æ™‚${p.value%60}åˆ† (${p.percent}%)` },
            series: [{ type: 'pie', radius: ['40%', '70%'], label: { show: true, formatter: '{b}\n{d}%' }, data: categories.map((c, i) => ({ name: c, value: d[c] })).filter(v => v.value > 0) }]
        });
    }

    window.onload = init;
</script>
</body>
</html>